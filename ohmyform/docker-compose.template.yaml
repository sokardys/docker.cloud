## TODO: add a compose examples directory with various deployment options.
version: "3.4"

services:
  redis:
    image: redis:${REDIS_VERSION}
    networks:
      - default
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
    volumes:
      - "${REDIS_DATA}:/data"
  mongo:
    image: mongo:${MONGO_VERSION}
    networks:
      - default
      - monitoring
    volumes:
      - "${MONGO_DATA}:/data/db"
    deploy:
      mode: global
      restart_policy:
        condition: on-failure

  ohmyform:
    image: ohmyform/ohmyform:${OHMYFORM_VERSION}
    networks:
      - web
      - default
    environment:
      - NODE_ENV=${NODE_ENV}
      - SESSION_SECRET=${SESSION_SECRET}
      - BASE_URL=${DOMAIN}
      - MONGODB_URI=${MONGODB_URI}
      - REDIS_URL=${REDIS_URL}
      - SOCKET_URL=${DOMAIN}
      - SIGNUP_DISABLED=${SIGNUP_DISABLED}
      - SUBDOMAINS_DISABLED=${SUBDOMAINS_DISABLED}
      - ENABLE_CLUSTER_MODE=${ENABLE_CLUSTER_MODE}
      - MAILER_EMAIL_ID=${MAILER_EMAIL_ID}
      - MAILER_PASSWORD=${MAILER_PASSWORD}
      - MAILER_FROM=${MAILER_FROM}
      - MAILER_SERVICE_PROVIDER=${MAILER_SERVICE_PROVIDER}
      - MAILER_SMTP_HOST=${MAILER_SMTP_HOST}
      - MAILER_SMTP_PORT=${MAILER_SMTP_PORT}
      - MAILER_SMTP_SECURE=${MAILER_SMTP_SECURE}
      - CREATE_ADMIN=${CREATE_ADMIN}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - APP_NAME=${APP_NAME}
      - APP_DESC=${APP_DESC}
      - APP_KEYWORDS=${APP_KEYWORDS}
      - RAVEN_DSN=${RAVEN_DSN}
      - GOOGLE_ANALYTICS_ID=${GOOGLE_ANALYTICS_ID}
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        failure_action: rollback
        delay: 1m
        order: start-first
      restart_policy:
        condition: on-failure
      labels:
        - traefik.enable=true
        - traefik.port=5000
        - traefik.docker.network=web
        - traefik.frontend.redirect.entryPoint=${DOMAIN_ENTRYPOINT}
        - traefik.frontend.passHostHeader=true
        - traefik.frontend.rule=Host:${DOMAIN}
        - traefik.backend.loadbalancer.swarm=true
        - traefik.backend.loadbalancer.stickiness=true

networks:
  web:
    external: true
  monitoring:
    external: true